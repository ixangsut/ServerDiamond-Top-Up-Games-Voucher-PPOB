<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Diamond - Website Topup Game, E-Wallet, dan App Premium #1 Di Indonesia yang Tercepat dan Terpercaya</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.4/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        /* Gaya CSS Umum dan Khusus Pembeli (Tidak ada perubahan signifikan) */
        :root {
            --color-primary-dark: #CCFF00; /* Hijau Stabilo (Lime Green) */
            --color-accent-green: #99CC00; /* Chartreuse Green, sedikit lebih gelap */
            --color-text-light: #F0F0F0; /* Abu-abu sangat terang */
            --border-radius-lg: 12px;
            --color-nokos-text: #FF00FF; 
            --shadow-base: 0 4px 10px rgba(0, 0, 0, 0.4);
            --shadow-hover: 0 8px 20px rgba(0, 0, 0, 0.6);
            --glow-accent: 0 0 15px rgba(153, 204, 0, 0.9); /* Glow Hijau Stabilo */
        }
        body { font-family: 'Montserrat', sans-serif; background-color: #000000; color: #FFF; overflow-x: hidden; }
        .container { max-width: 992px; padding-top: 0; } 
        
        /* Navbar */
        .navbar-custom { background-color: #000000; border-bottom: 2px solid var(--color-accent-green); padding: 10px 0; }
        .navbar-brand { transition: transform 0.3s ease, text-shadow 0.3s ease; color: var(--color-primary-dark) !important; }
        .navbar-brand:hover { transform: scale(1.05); text-shadow: 0 0 8px var(--color-primary-dark); } 
        .navbar-brand img { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--color-primary-dark); object-fit: cover; }
        .navbar-nav .nav-link { color: var(--color-text-light) !important; font-weight: 700; transition: color 0.3s, transform 0.2s; }
        .navbar-nav .nav-link:hover { color: var(--color-primary-dark) !important; transform: translateY(-2px); }

        #back-button { transition: all 0.3s ease; color: var(--color-primary-dark) !important; border-color: var(--color-primary-dark) !important; }
        #back-button:hover { transform: scale(1.05); background-color: rgba(204,255,0,0.1); }
        
        /* Carousel & Sections */
        .hero-banner { padding: 15px 0 0 0; margin-bottom: 20px; }
        .carousel-item img { 
            width: 100%; height: auto; border-radius: var(--border-radius-lg); 
            box-shadow: var(--shadow-base); transition: box-shadow 0.3s ease;
        }
        .carousel-item img:hover { box-shadow: var(--shadow-hover); }

        .flashsale-section { 
            background-color: #111111; 
            color: var(--color-text-light); padding: 15px; border-radius: var(--border-radius-lg); 
            margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; 
            box-shadow: var(--shadow-base);
        }
        .countdown-box { background-color: #000; color: var(--color-primary-dark); padding: 5px 8px; margin: 0 2px; border-radius: 4px; font-weight: 700; font-size: 1.2rem; line-height: 1; }
        
        /* Gaya Produk Flashsale (Nokos Indo) */
        .flashsale-item { 
            background-color: #222222; 
            border-radius: var(--border-radius-lg); padding: 15px; margin-top: 15px; 
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease; 
            position: relative; display: flex; justify-content: space-between; align-items: center; cursor: pointer; 
            box-shadow: var(--shadow-base);
        }
        .flashsale-item:hover { 
            transform: translateY(-5px) scale(1.02); 
            box-shadow: var(--shadow-hover); 
            background-color: #333333; 
        }
        
        /* Gaya Khusus untuk status SOLD OUT */
        .flashsale-item.sold-out {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #111111;
        }
        .flashsale-item.sold-out:hover {
            transform: none;
            box-shadow: var(--shadow-base);
            background-color: #111111;
        }

        /* Gaya untuk teks SOLD OUT yang akan ditambahkan via JS */
        .flashsale-item .sold-out-text {
            color: #CC0000;
            font-weight: 700;
            margin-left: 10px;
            font-size: 1rem;
        }
        
        .flashsale-price-old { text-decoration: line-through; color: #888888; font-size: 0.8rem; }
        
        /* PERUBAHAN FONT NOKOS (FLASHSALE) - "OTP Nokos INDO" */
        .flashsale-item .text-content p { 
             font-weight: 900 !important; 
             color: #FFFFFF; 
             text-shadow: 1px 1px 2px #000;
        }
        
        /* [PERUBAHAN FONT HARGA NOKOS] */
        .flashsale-price-new { 
            font-size: 1.6rem; 
            font-weight: 900;
            color: var(--color-primary-dark); 
            text-shadow: 2px 2px 3px rgba(0,0,0,0.7);
        }
        
        /* MENYEMBUNYIKAN BADGE READY/SOLD OUT (Sesuai Perintah) */
        #flashsale-badge {
            display: none !important; 
        }

        /* PERUBAHAN UNTUK PRODUK GRID (POPULER) */
        .product-card { 
            background-color: #222222; 
            border-radius: var(--border-radius-lg); padding: 15px; 
            text-align: center; cursor: pointer; height: 100%; 
            transition: all 0.3s ease; 
            box-shadow: var(--shadow-base); 
            position: relative; overflow: hidden; 
            color: var(--color-text-light); 
        }
        .product-card:hover { 
            background-color: #333333; 
            transform: translateY(-8px) scale(1.03); 
            box-shadow: var(--shadow-hover); 
        }
        .product-card img { 
            width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-bottom: 10px; 
            border: 2px solid #555;
            transition: transform 0.3s ease; 
        }
        .product-card:hover img { 
            transform: scale(1.1); 
            border-color: var(--color-primary-dark);
        } 
        
        /* PERUBAHAN FONT NAMA PRODUK DI GRID */
        .product-card p {
            font-weight: 700; 
            color: white; 
        }
        
        /* MENGHILANGKAN KATEGORI DARI TAMPILAN KARTU PRODUK */
        .product-card small {
            display: none !important; 
        }
        
        .section-title { font-weight: 700; color: var(--color-primary-dark); margin-bottom: 20px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); }
        
        /* Sub-section Title untuk Game/E-Wallet/App Premium */
        .subsection-title {
            font-weight: 800;
            color: var(--color-text-light); 
            text-align: center;
            margin: 30px 0 20px 0;
            padding: 10px 0;
            border-bottom: 3px solid var(--color-primary-dark);
            border-top: 3px solid var(--color-primary-dark);
            background-color: #111111;
            border-radius: 8px;
            box-shadow: var(--shadow-base);
        }

        /* Product Page & Checkout Styles */
        #product-page { background-color: var(--color-text-light); color: #333; min-height: 100vh; padding-bottom: 50px; }
        .product-page-header { background-color: var(--color-accent-green); color: black; padding: 15px; border-bottom-left-radius: var(--border-radius-lg); border-bottom-right-radius: var(--border-radius-lg); margin-bottom: 20px; }
        .card-checkout { background-color: white; border-radius: var(--border-radius-lg); padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-base); }
        
        .nominal-item, .payment-item { 
            border: 2px solid #EEE; border-radius: 8px; padding: 10px; text-align: center; cursor: pointer; 
            transition: all 0.3s ease-in-out; background-color: white; color: #333; height: 100%; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); 
        }
        .nominal-item:not(.active):hover, .payment-item:not(.active):hover {
            border-color: var(--color-primary-dark); 
            background-color: #F8FFC4; 
            transform: scale(1.02);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .nominal-item.active, .payment-item.active { 
            border-color: var(--color-accent-green); 
            background-color: #E8FFB5; 
            box-shadow: var(--glow-accent); 
            transform: scale(1.03); 
        }

        /* PERUBAHAN FONT NOKOS (DETAIL NOMINAL) */
        .nominal-item-nokos .nominal-label { font-weight: 800; color: #333; font-size: 1rem; }
        
        /* [PERUBAHAN FONT HARGA NOMINAL] */
        .price-label { font-weight: 700; color: #DC3545; font-size: 0.9rem; }
        
        /* PERUBAHAN FONT APP PREMIUM (DETAIL NOMINAL) */
        .nominal-item-apppremium { font-weight: 800; color: #333; font-size: 1rem; }
        
        /* STYLE UNTUK E-WALLET NOMINAL */
        .nominal-item-ewallet { font-weight: 800; color: #333; font-size: 1rem; }
        
        /* STYLE UNTUK GAME NOMINAL */
        .nominal-item-game { font-weight: 800; color: #333; font-size: 1rem; }

        /* Input Form Focus */
        .form-control:focus {
            border-color: var(--color-accent-green);
            box-shadow: 0 0 0 0.25rem rgba(153, 204, 0, 0.25);
            outline: 0;
        }

        /* Button Process Order */
        .btn-process-order {
            background-color: var(--color-primary-dark); 
            color: black; 
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-base);
        }
        .btn-process-order:hover {
            background-color: var(--color-accent-green); 
            transform: translateY(-3px) scale(1.01);
            box-shadow: var(--glow-accent); 
        }
        
        /* Floating Chat Button */
        #floating-chat-btn {
            position: fixed; bottom: 20px; right: 20px; z-index: 9000;
            width: 60px; height: 60px; border-radius: 50%;
            background-color: var(--color-primary-dark); color: black; 
            box-shadow: var(--shadow-base); 
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            display: flex; justify-content: center; align-items: center;
        }
        #floating-chat-btn:hover {
            transform: scale(1.1); 
            box-shadow: var(--glow-accent); 
            background-color: var(--color-accent-green);
        }
        
        /* Chat Page & Modals */
        #chat-page { 
            background-color: var(--color-text-light); color: #333; min-height: 100vh; 
            padding-bottom: 70px; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh; z-index: 9001;
            overflow: hidden;
        }
        .chat-container { height: 100%; display: flex; flex-direction: column; }
        .chat-log { flex-grow: 1; overflow-y: auto; padding: 15px; background-color: white; }
        .message-box { padding: 8px 12px; margin: 5px; border-radius: 15px; max-width: 80%; word-wrap: break-word; font-size: 0.9rem; }
        .message-sender { background-color: var(--color-primary-dark); color: black; margin-left: auto; border-bottom-right-radius: 2px; }
        .message-receiver { background-color: #EEE; color: #333; margin-right: auto; border-bottom-left-radius: 2px; }
        .chat-input-area { padding: 10px 0; background-color: white; border-top: 1px solid #DDD; }

        /* Modal Customization */
        .modal-content { border-radius: var(--border-radius-lg); animation: fadeInScale 0.3s ease-out; }
        .modal-header {
            background-color: var(--color-primary-dark) !important; 
            color: black !important; 
            border-top-left-radius: var(--border-radius-lg);
            border-top-right-radius: var(--border-radius-lg);
        }
        .modal-header .modal-title { color: black !important; }
        .btn-close-white { filter: invert(0) grayscale(100%) brightness(0) !important; opacity: 1; }

        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Gaya untuk halaman informasi */
        .info-page {
            background-color: #000;
            color: var(--color-text-light);
            min-height: 100vh;
            padding: 20px 0;
        }
        
        .info-card {
            background-color: #111111;
            border-radius: var(--border-radius-lg);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-base);
            border: 1px solid #333;
        }
        
        .info-card h2 {
            color: var(--color-primary-dark);
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .info-card h3 {
            color: var(--color-accent-green);
            font-weight: 700;
            margin-top: 25px;
            margin-bottom: 15px;
        }
        
        .info-card p, .info-card li {
            color: var(--color-text-light);
            line-height: 1.6;
            margin-bottom: 10px;
        }
        
        .info-card ul, .info-card ol {
            padding-left: 20px;
        }
        
        .contact-info {
            background-color: #111111;
            border-radius: var(--border-radius-lg);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-base);
            border: 1px solid #333;
            text-align: center;
        }
        
        .contact-info h2 {
            color: var(--color-primary-dark);
            font-weight: 800;
            margin-bottom: 20px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .contact-item {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #222222;
            border-radius: var(--border-radius-lg);
            transition: all 0.3s ease;
        }
        
        .contact-item:hover {
            background-color: #333333;
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }
        
        .contact-item i {
            font-size: 2rem;
            color: var(--color-primary-dark);
            margin-bottom: 10px;
        }
        
        .contact-item h4 {
            color: var(--color-text-light);
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .contact-item p {
            color: var(--color-text-light);
            margin-bottom: 0;
        }
        
        .contact-link {
            color: var(--color-primary-dark);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .contact-link:hover {
            color: var(--color-accent-green);
            text-decoration: underline;
        }
        
    </style>
</head>
<body>
    
    <div id="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10001; justify-content: center; align-items: center; flex-direction: column; color: white;">
        <div class="spinner-border text-light" role="status"></div>
        <p class="mt-3 fw-bold" id="loading-status">Memuat data...</p>
    </div>
    <div id="custom-toast" style="display: none; position: fixed; top: 20px; right: 20px; z-index: 10000; padding: 12px 25px; border-radius: 8px; opacity: 0; transition: opacity 0.5s, transform 0.3s;"></div>
    
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top navbar-custom" id="main-navbar">
        <div class="container">
            <a class="navbar-brand fw-bold" href="javascript:void(0)" onclick="goToMainPage()">
                <img src="https://i.ibb.co.com/4g2F7qD7/logo.jpg" alt="Logo Server Diamond"> Server Diamond
            </a>
            
            <button class="btn btn-outline-light d-none" id="back-button" onclick="handleBackButton()">
                <i class="fas fa-arrow-left"></i> Kembali
            </button>
            
            <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="javascript:void(0)" onclick="goToMainPage()" data-bs-toggle="collapse" data-bs-target="#navbarNav">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="javascript:void(0)" onclick="showCheckStatusModal()" data-bs-toggle="collapse" data-bs-target="#navbarNav">Cek Status Pesanan</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://wa.me/628980943928" target="_blank">Bantuan</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Info
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="showPrivacyPolicy()">Kebijakan Privasi</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="showTermsConditions()">Syarat & Ketentuan</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="showContact()">Kontak</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    
    <div id="main-page" class="container pb-5 animate__animated animate__fadeInUp"> 
        <section class="hero-banner" data-aos="zoom-in-up" data-aos-duration="400"> 
            <div id="bannerCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                    <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
                    <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
                    <button type="button" data-bs-target="#bannerCarousel" data-bs-slide-to="3" aria-label="Slide 4"></button>
                </div>
                <div class="carousel-inner">
                    <div class="carousel-item active" data-bs-interval="5000">
                        <img src="https://i.ibb.co.com/67HNnYWg/0c49dbfd037a955d2bc9b4a4a55387d6-1.jpg" class="d-block w-100" alt="Banner Utama">
                    </div>
                    <div class="carousel-item" data-bs-interval="5000">
                        <img src="https://i.ibb.co.com/C50dNxHq/merchants2-Fbanners2-FBayar20pakai20qris.jpg" class="d-block w-100" alt="Banner Bayar Pakai QRIS">
                    </div>
                    <div class="carousel-item" data-bs-interval="5000">
                        <img src="https://i.ibb.co.com/67HNnYWg/0c49dbfd037a955d2bc9b4a4a55387d6-1.jpg" class="d-block w-100" alt="Banner Bayar Pakai QRIS">
                    </div>
                    <div class="carousel-item" data-bs-interval="5000">
                        <img src="https://i.ibb.co.com/C50dNxHq/merchants2-Fbanners2-FBayar20pakai20qris.jpg" class="d-block w-100" alt="Banner Bayar Pakai QRIS">
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#bannerCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#bannerCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        </section>

        <section class="mt-4" data-aos="fade-right">
            <h4 class="section-title"><i class="fas fa-bolt me-2"></i> FLASHSALE</h4>
            
            <div class="flashsale-section">
                <p class="mb-0 fw-normal">Waktu Tersisa:</p>
                <div id="countdown-timer">
                    <span class="countdown-box" id="cd-h">00</span>:
                    <span class="countdown-box" id="cd-m">00</span>:
                    <span class="countdown-box" id="cd-s">00</span>
                </div>
            </div>
            
            <div id="flashsale-otp" class="flashsale-item" onclick="showProductPage('NOKOS')" data-aos="fade-left"> 
                <div class="text-content">
                    <p class="mb-1 fw-normal">Nokos WhatsApp +62</p>
                    <span class="flashsale-price-old">Rp 8.000</span>
                    <span class="flashsale-price-new ms-2">Rp 5.000</span>
                    <span class="badge bg-warning text-dark fw-normal ms-2" id="flashsale-badge">READY</span>
                </div>
                <i class="fas fa-arrow-right text-light" id="flashsale-indicator"></i>
            </div>
        </section>

        <section class="mt-5" data-aos="fade-up">
            <h4 class="section-title"><i class="fas fa-fire me-2"></i> POPULER</h4>
            
            <div id="product-grid">
                </div>

        </section>
        
    </div>
    
    <div id="product-page" style="display: none;"> 
        <div class="product-page-header">
            <div class="container">
                <div class="d-flex align-items-center">
                    <img src="" id="product-page-img" alt="Product Image" style="width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; border: 2px solid white;">
                    <div>
                        <h4 class="mb-0 fw-normal" id="product-page-title">PRODUCT NAME</h4>
                        <small id="product-page-type"></small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="container">
            
            <div class="card-checkout mt-4" data-aos="fade-up">
                <h5 class="fw-normal mb-3" id="nominal-title" style="color: #333;"><i class="fas fa-list me-2" style="color: var(--color-primary-dark);"></i> 1. Pilih Kategori/Nominal</h5> 
                <div id="product-nominal-list" class="row g-2">
                    <p class="text-center text-muted">Memuat nominal...</p>
                </div>
            </div>
            
            <div class="card-checkout" id="recipient-card" data-aos="fade-up">
                <h5 class="fw-normal mb-3" style="color: #333;"><i class="fas fa-user-circle me-2" style="color: var(--color-primary-dark);"></i> 2. Masukkan Data Tujuan</h5>
                <div class="mb-3">
                    <label for="input-recipient-id-page" class="form-label fw-normal" id="recipient-label-page">Nomor Tujuan / ID Pelanggan</label>
                    <input type="text" class="form-control" id="input-recipient-id-page" placeholder="Cth: 081234567890"> 
                    <small class="form-text text-muted" id="recipient-help-page">Masukkan nomor dengan benar.</small>
                </div>
            </div>

            <div class="card-checkout" data-aos="fade-up">
                <h5 class="fw-normal mb-3" style="color: #333;"><i class="fas fa-credit-card me-2" style="color: var(--color-primary-dark);"></i> 3. Pilih Metode Pembayaran</h5>
                <div id="payment-method-selection-page" class="row g-3 mb-4">
                    </div>
                
                <div id="final-tagihan" class="alert text-center py-3" style="background-color: #FEE; border-color: #FCD;">
                    <span class="fw-normal fs-5 d-block text-dark">Total Tagihan:</span>
                    <span id="display-tagihan" class="d-block text-danger" style="font-size: 2.5rem; font-weight: 700;">0</span>
                    <div id="display-unique-code" class="small mt-1 text-dark"></div>
                    <input type="hidden" id="input-final-amount"> 
                </div>

                <button class="btn w-100 btn-lg mb-3 btn-process-order" onclick="processOrderFromPage()">
                    <i class="fas fa-paper-plane me-2"></i> PROSES PESANAN SEKARANG
                </button>
                
                <p class="small text-center text-muted">Pastikan Anda sudah memilih nominal dan memasukkan ID/Nomor tujuan.</p>
                <p class="small text-center text-danger" id="nokos-checkout-warning" style="display: none;">
                    *Untuk order Nokos, Anda akan diarahkan ke halaman pembayaran, lalu ke Live Chat untuk konfirmasi dan mendapatkan layanan.
                </p>
            </div>
            
        </div>
    </div>
    
    <!-- Halaman Kebijakan Privasi -->
    <div id="privacy-policy-page" class="info-page" style="display: none;">
        <div class="container">
            <div class="d-flex align-items-center mb-4">
                <button class="btn btn-sm btn-outline-light me-3" onclick="goToMainPage()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
                <h1 class="fw-bold mb-0" style="color: var(--color-primary-dark);">Kebijakan Privasi</h1>
            </div>
            
            <div class="info-card">
                <h2>Kebijakan Privasi Server Diamond</h2>
                
                <p>Terakhir diperbarui: 1 Januari 2024</p>
                
                <h3>1. Pengumpulan Informasi</h3>
                <p>Kami mengumpulkan informasi berikut dari pengguna:</p>
                <ul>
                    <li>Informasi pribadi (nama, alamat email, nomor telepon)</li>
                    <li>Informasi transaksi (riwayat pembelian, metode pembayaran)</li>
                    <li>Data teknis (alamat IP, jenis perangkat, browser)</li>
                    <li>Informasi ID game dan akun terkait</li>
                </ul>
                
                <h3>2. Penggunaan Informasi</h3>
                <p>Informasi yang kami kumpulkan digunakan untuk:</p>
                <ul>
                    <li>Memproses pesanan dan transaksi</li>
                    <li>Memberikan layanan pelanggan</li>
                    <li>Meningkatkan pengalaman pengguna</li>
                    <li>Mengirim pembaruan dan promosi</li>
                    <li>Memenuhi kewajiban hukum</li>
                </ul>
                
                <h3>3. Perlindungan Data</h3>
                <p>Kami menerapkan langkah-langkah keamanan yang tepat untuk melindungi informasi pribadi Anda dari akses, pengungkapan, atau penggunaan yang tidak sah.</p>
                
                <h3>4. Berbagi Informasi</h3>
                <p>Kami tidak menjual, memperdagangkan, atau mentransfer informasi pribadi Anda kepada pihak ketiga tanpa persetujuan Anda, kecuali:</p>
                <ul>
                    <li>Untuk mematuhi hukum atau proses hukum</li>
                    <li>Untuk melindungi hak, properti, atau keselamatan kami</li>
                    <li>Dengan penyedia layanan yang membantu operasi kami</li>
                </ul>
                
                <h3>5. Cookie</h3>
                <p>Kami menggunakan cookie untuk meningkatkan pengalaman pengguna dan menganalisis lalu lintas situs web.</p>
                
                <h3>6. Hak Pengguna</h3>
                <p>Anda memiliki hak untuk:</p>
                <ul>
                    <li>Mengakses informasi pribadi Anda</li>
                    <li>Memperbaiki informasi yang tidak akurat</li>
                    <li>Menghapus informasi pribadi Anda</li>
                    <li>Menolak pemrosesan data tertentu</li>
                </ul>
                
                <h3>7. Perubahan Kebijakan</h3>
                <p>Kami dapat memperbarui kebijakan privasi ini dari waktu ke waktu. Perubahan akan diberitahukan melalui situs web kami.</p>
                
                <h3>8. Kontak</h3>
                <p>Jika Anda memiliki pertanyaan tentang kebijakan privasi ini, silakan hubungi kami melalui:</p>
                <ul>
                    <li>Email: privacy@serverdiamond.com</li>
                    <li>WhatsApp: +62 889-8094-3928</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Halaman Syarat dan Ketentuan -->
    <div id="terms-conditions-page" class="info-page" style="display: none;">
        <div class="container">
            <div class="d-flex align-items-center mb-4">
                <button class="btn btn-sm btn-outline-light me-3" onclick="goToMainPage()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
                <h1 class="fw-bold mb-0" style="color: var(--color-primary-dark);">Syarat & Ketentuan</h1>
            </div>
            
            <div class="info-card">
                <h2>Syarat dan Ketentuan Server Diamond</h2>
                
                <p>Terakhir diperbarui: 1 Januari 2024</p>
                
                <h3>1. Penerimaan Syarat</h3>
                <p>Dengan mengakses dan menggunakan layanan Server Diamond, Anda setuju untuk terikat oleh syarat dan ketentuan ini.</p>
                
                <h3>2. Layanan</h3>
                <p>Server Diamond menyediakan layanan top-up game, e-wallet, dan aplikasi premium. Kami berusaha memberikan layanan yang terbaik, namun:</p>
                <ul>
                    <li>Kami tidak bertanggung jawab atas masalah yang disebabkan oleh developer game atau penyedia layanan</li>
                    <li>Proses pengiriman dapat memakan waktu hingga 24 jam</li>
                    <li>Kami berhak menolak pesanan yang mencurigakan</li>
                </ul>
                
                <h3>3. Pembayaran</h3>
                <p>Semua pembayaran harus dilakukan melalui metode yang telah disediakan. Setelah pembayaran dikonfirmasi, pesanan akan diproses.</p>
                
                <h3>4. Kebijakan Pengembalian Dana</h3>
                <p>Pengembalian dana hanya dapat dilakukan dalam kondisi tertentu:</p>
                <ul>
                    <li>Pesanan tidak dapat diproses karena kesalahan sistem</li>
                    <li>Pesanan duplikat</li>
                    <li>Kesalahan nominal yang tidak sesuai</li>
                </ul>
                <p>Pengembalian dana tidak berlaku untuk:</p>
                <ul>
                    <li>Kesalahan input data oleh pengguna</li>
                    <li>Perubahan pikiran setelah pembayaran</li>
                    <li>Masalah yang disebabkan oleh developer game</li>
                </ul>
                
                <h3>5. Akun Pengguna</h3>
                <p>Anda bertanggung jawab untuk:</p>
                <ul>
                    <li>Menjaga kerahasiaan informasi akun</li>
                    <li>Memastikan keakuratan informasi yang diberikan</li>
                    <li>Segera melaporkan aktivitas mencurigakan</li>
                </ul>
                
                <h3>6. Larangan</h3>
                <p>Anda dilarang:</p>
                <ul>
                    <li>Menggunakan layanan untuk aktivitas ilegal</li>
                    <li>Mencoba mengakses sistem tanpa izin</li>
                    <li>Melakukan penipuan atau penyalahgunaan</li>
                    <li>Menyebarkan malware atau konten berbahaya</li>
                </ul>
                
                <h3>7. Perubahan Layanan</h3>
                <p>Kami berhak mengubah, menangguhkan, atau menghentikan layanan kapan saja tanpa pemberitahuan sebelumnya.</p>
                
                <h3>8. Batasan Tanggung Jawab</h3>
                <p>Server Diamond tidak bertanggung jawab atas kerugian tidak langsung yang timbul dari penggunaan layanan kami.</p>
                
                <h3>9. Hukum yang Berlaku</h3>
                <p>Syarat dan ketentuan ini diatur oleh hukum Republik Indonesia.</p>
                
                <h3>10. Kontak</h3>
                <p>Untuk pertanyaan tentang syarat dan ketentuan, hubungi kami melalui:</p>
                <ul>
                    <li>Email: legal@serverdiamond.com</li>
                    <li>WhatsApp: +62 812-3456-7890</li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Halaman Kontak -->
    <div id="contact-page" class="info-page" style="display: none;">
        <div class="container">
            <div class="d-flex align-items-center mb-4">
                <button class="btn btn-sm btn-outline-light me-3" onclick="goToMainPage()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
                <h1 class="fw-bold mb-0" style="color: var(--color-primary-dark);">Kontak Kami</h1>
            </div>
            
            <div class="contact-info">
                <h2>Hubungi Server Diamond</h2>
                <p class="mb-4">Kami siap membantu Anda dengan segala pertanyaan dan masalah yang mungkin Anda hadapi.</p>
                
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="contact-item">
                            <i class="fab fa-whatsapp"></i>
                            <h4>WhatsApp</h4>
                            <p>+62 812-3456-7890</p>
                            <a href="https://wa.me/6281234567890" class="contact-link" target="_blank">Hubungi Sekarang</a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="contact-item">
                            <i class="fas fa-envelope"></i>
                            <h4>Email</h4>
                            <p>support@serverdiamond.com</p>
                            <a href="mailto:support@serverdiamond.com" class="contact-link">Kirim Email</a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="contact-item">
                            <i class="fas fa-clock"></i>
                            <h4>Jam Operasional</h4>
                            <p>Senin - Minggu</p>
                            <p>08:00 - 22:00 WIB</p>
                        </div>
                    </div>
                </div>
                
                <div class="info-card mt-4">
                    <h3>Pusat Bantuan</h3>
                    <p>Sebelum menghubungi kami, silakan periksa Pusat Bantuan kami untuk solusi cepat:</p>
                    <ul>
                        <li><strong>Cek Status Pesanan:</strong> Gunakan fitur "Cek Status Pesanan" di halaman utama</li>
                        <li><strong>Panduan Pembelian:</strong> Pastikan Anda telah membaca panduan pembelian dengan benar</li>
                        <li><strong>Pertanyaan Umum:</strong> Banyak pertanyaan sudah terjawab di FAQ kami</li>
                    </ul>
                </div>
                
                <div class="info-card mt-4">
                    <h3>Layanan Pelanggan</h3>
                    <p>Tim layanan pelanggan kami siap membantu Anda dengan:</p>
                    <ul>
                        <li>Pertanyaan tentang produk dan layanan</li>
                        <li>Bantuan dengan pesanan dan pembayaran</li>
                        <li>Keluhan dan saran</li>
                        <li>Bantuan teknis</li>
                    </ul>
                    <p>Kami berkomitmen untuk merespons semua pertanyaan dalam waktu 24 jam.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="chat-page" style="display: none;">
        <div class="container py-3 h-100">
            <div class="d-flex align-items-center mb-3">
                <button class="btn btn-sm btn-outline-dark me-3" onclick="goToMainPage()">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
                <h4 class="fw-normal mb-0 text-dark">Live Chat</h4>
            </div>
            
            <div class="chat-container">
                <div id="nokos-manual-info" class="alert alert-danger" style="display: none;">
                    </div>

                <div class="chat-log" id="customer-chat-log">
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i> Menghubungkan ke Admin...
                    </div>
                </div>
                <div class="chat-input-area container">
                    <div class="input-group">
                        <input type="text" class="form-control" id="customer-chat-input" placeholder="Tulis pesan..." onkeypress="if(event.keyCode==13) sendCustomerMessage()">
                        <button class="btn" style="background-color: var(--color-primary-dark); color: black;" onclick="sendCustomerMessage()">KIRIM
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="payment-modal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white">
                    <h5 class="modal-title" id="modalTitle">INSTRUKSI PEMBAYARAN</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="modal-payment-content"></div>
                    <div class="alert mt-4 small border-start border-3" style="border-color: var(--color-primary-dark) !important;">
                        Simpan ID Order ini: <span id="modal-order-id-display" style="color: var(--color-primary-dark); font-weight: 700;">#IDORDER</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyText('modal-order-id-display')"><i class="fas fa-copy"></i> Salin</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    <div class="modal fade" id="check-status-modal" tabindex="-1" aria-labelledby="checkStatusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header text-white">
                    <h5 class="modal-title" id="checkStatusModalLabel">CEK STATUS PESANAN</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-dark">Masukkan ID Pesanan Anda:</p>
                    <input type="text" class="form-control mb-3" id="input-check-order-id" placeholder="Contoh: XA7B9C0D">
                    <button class="btn btn-primary" style="background-color: var(--color-accent-green); border-color: var(--color-accent-green); color: black;" onclick="checkOrderStatus()">
                        <i class="fas fa-search me-1"></i> Cek Status
                    </button>
                    <div id="order-status-result" class="mt-4 text-start p-3 border rounded text-dark" style="background-color: #F7F7F7; display: none;">
                        </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="text-center py-3 mt-5" style="background-color: #000000; color: white; border-top: 2px solid var(--color-accent-green);">
        <div class="container">
            <small>&copy; 2024 Server Diamond. All rights reserved.</small>
            <div class="mt-2">
                <a href="javascript:void(0)" onclick="showPrivacyPolicy()" class="text-light me-3">Kebijakan Privasi</a>
                <a href="javascript:void(0)" onclick="showTermsConditions()" class="text-light me-3">Syarat & Ketentuan</a>
                <a href="javascript:void(0)" onclick="showContact()" class="text-light">Kontak</a>
            </div>
        </div>
    </footer>

    <button class="btn" id="floating-chat-btn" onclick="startCustomerChat(false)">
    <span style="font-size: 28px;">ðŸ’¬</span> 
</button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <script>
    // =========================================================
    //                 SETUP FIREBASE & KONFIGURASI
    // =========================================================
        const firebaseConfig = {
            // **PASTIKAN INI DATA FIREBASE ANDA!** (Ganti ini dengan konfigurasi Anda yang sebenarnya jika perlu)
            apiKey: "AIzaSyBh4nWQo6iHwLRkvjKn0fJ_xYkW7c",
            authDomain: "amripay-system.firebaseapp.com",
            databaseURL: "https://amripay-system-default-rtdb.firebaseio.com",
            projectId: "amripay-system",
            storageBucket: "amripay-system-default-rtdb.firebaseio.com",
            messagingSenderId: "3319778608609",
            appId: "1:3319778608609:web:dfe809b1fa197f54f74ca0",
            measurementId: "G-LW55BHM4Y8"
        };
        
        let db;
        let ORDERS_REF = 'orders/'; 
        let CHAT_REF = 'chat_sessions/';
        
        // --- KONFIGURASI HARGA (Tidak ada perubahan pada data ini) ---
        const PRODUCT_DATA = {
            NOKOS: { type: 'LAINNYA', label: 'OTP Nokos INDO', image: 'https://i.ibb.co.com/4g2F7qD7/logo.jpg', nominals: { 1: 5000 } },
            DANA: { 
                type: 'E-WALLET', 
                label: 'DANA', 
                image: 'https://ar-hosting.pages.dev/1761547363209.jpg', 
                nominals: { 
                    10000: 13000, 20000: 23000, 25000: 28000, 30000: 33000, 35000: 38000, 40000: 43000, 45000: 48000, 50000: 53000, 55000: 58000, 60000: 63000, 65000: 68000, 70000: 73000, 75000: 78000, 80000: 83000, 85000: 88000, 90000: 93000, 95000: 98000, 100000: 103000, 125000: 127000, 150000: 152000, 200000: 202000, 250000: 252000, 300000: 302000, 350000: 352000, 400000: 402000, 500000: 501000, 600000: 601000, 700000: 701000, 800000: 800000, 900000: 899000, 1000000: 997000, 2000000: 1995000, 3000000: 2990000
                } 
            },
            OVO: { 
                type: 'E-WALLET', 
                label: 'OVO', 
                image: 'https://ar-hosting.pages.dev/1761547406091.jpg', 
                nominals: { 
                    10000: 13000, 20000: 23000, 25000: 28000, 30000: 33000, 40000: 43000, 45000: 43000, 50000: 53000, 55000: 58000, 60000: 63000, 70000: 73000, 75000: 77000, 80000: 82000, 90000: 92000, 95000: 97000, 100000: 102000, 125000: 126000, 150000: 151000, 175000: 176000, 200000: 200000, 250000: 250000, 300000: 299000, 350000: 349000, 400000: 398000, 450000: 448000, 500000: 496000, 600000: 594000, 700000: 692000, 750000: 740000, 800000: 788000, 900000: 883000, 1000000: 980000, 1500000: 1470000, 2000000: 1950000
                } 
            },
            GOPAY: { 
                type: 'E-WALLET', 
                label: 'GOPAY', 
                image: 'https://ar-hosting.pages.dev/1761547436895.jpg', 
                nominals: { 
                    10000: 13000, 15000: 18000, 20000: 23000, 25000: 28000, 30000: 33000, 35000: 38000, 40000: 43000, 45000: 48000, 50000: 53000, 55000: 58000, 60000: 63000, 65000: 68000, 70000: 73000, 75000: 78000, 80000: 83000, 85000: 88000, 90000: 93000, 95000: 98000, 100000: 102000, 150000: 152000, 200000: 201000, 250000: 251000, 300000: 300000, 400000: 399000, 450000: 449000, 500000: 498000, 700000: 694000, 900000: 885000
                } 
            },
            SHOPEEPAY: { 
                type: 'E-WALLET', 
                label: 'SHOPEEPAY', 
                image: 'https://ar-hosting.pages.dev/1761547482410.jpg', 
                nominals: { 
                    10000: 13000, 15000: 18000, 20000: 23000, 25000: 28000, 30000: 33000, 35000: 38000, 40000: 43000, 45000: 48000, 50000: 53000, 55000: 58000, 60000: 63000, 65000: 68000, 70000: 73000, 75000: 72000, 80000: 82000, 85000: 87000, 90000: 92000, 95000: 97000, 100000: 101000, 150000: 151000, 200000: 200000, 250000: 250000, 300000: 299000, 350000: 349000, 400000: 398000, 450000: 448000, 500000: 496000, 600000: 594000, 700000: 688000, 800000: 783000, 900000: 880000, 1000000: 975000
                } 
            },
            MLBB: { 
                type: 'GAME', 
                label: 'Mobile Legends', 
                image: 'https://ar-hosting.pages.dev/1761547858448.jpg', 
                nominals: { 
                    5: 1000, 10: 2000, 20: 4000, 50: 9000, 70: 10000, 140: 30000, 150: 33000, 210: 48000, 280: 60000, 355: 78000, 425: 103000, 500: 115000, 720: 152000, 860: 200000, 1000: 220000, 1450: 350000, 2160: 463000, 2980: 471000, 7290: 1579000, 36500: 7499000, 73100: 18800000
                } 
            },
            FF: { 
                type: 'GAME', 
                label: 'Free Fire', 
                image: 'https://ar-hosting.pages.dev/1761547927026.jpg', 
                nominals: { 
                    5: 2000, 10: 3000, 20: 4000, 50: 9000, 70: 14000, 140: 22000, 150: 26000, 210: 25000, 280: 45000, 355: 55000, 425: 66000, 500: 78000, 720: 108000, 860: 130000, 1000: 159000, 1450: 219000, 2180: 315000, 7290: 1056000, 36500: 5499000, 73100: 11200000,
                    'MINGGUAN': 35000, 'BULANAN': 92000, 'BP_CARD': 52000
                } 
            },
            ALIGHT: { type: 'APP PREMIUM', label: 'Alight Motion', image: 'https://ar-hosting.pages.dev/1761558700582.png', nominals: { '1_TAHUN': 7000 } }, 
            CAPCUT: { 
                type: 'APP PREMIUM', 
                label: 'CapCut Pro', 
                image: 'https://ar-hosting.pages.dev/1761558823883.png', 
                nominals: { '2_MINGGU': 12500, '1_BULAN': 20000 } 
            },
            APPLE_MUSIC: { type: 'APP PREMIUM', label: 'Apple Music', image: 'https://ar-hosting.pages.dev/1762240669625.png', nominals: { '1_BULAN': 10000 } },
            VIU: { type: 'APP PREMIUM', label: 'Viu', image: 'https://ar-hosting.pages.dev/1761558910917.png', nominals: { '6_BULAN': 6000 } }, 
            CANVA: { 
                type: 'APP PREMIUM', 
                label: 'Canva', 
                image: 'https://ar-hosting.pages.dev/1761558971780.png', 
                nominals: { 'INVITE_1_BULAN': 10000, 'OWNER_1_BULAN': 16000 } 
            },
            PICSART: { type: 'APP PREMIUM', label: 'Picsart', image: 'https://ar-hosting.pages.dev/1761559055786.png', nominals: { '30_HARI': 10000 } }, 
            PRIME: { type: 'APP PREMIUM', label: 'Prime Video', image: 'https://ar-hosting.pages.dev/1761559111710.png', nominals: { '1_BULAN_PRIVATE': 20000 } }, 
            ZOOM_APP: { type: 'APP PREMIUM', label: 'ZOOM', image: 'https://ar-hosting.pages.dev/1761559157488.png', nominals: { '14_HARI_100P': 10000 } } 
        };

        // --- KONFIGURASI METODE PEMBAYARAN: ---
        const PAYMENT_DETAILS = {
             QRIS: { label: 'QRIS', icon: 'fas fa-qrcode', image_url: "https://ar-hosting.pages.dev/1761073459128.jpg", name: "Server Diamond" },
             GOPAY: { label: 'GOPAY', icon: 'fas fa-wallet', number: "082315129977", name: "MUHAMMAD AMRI" }
        };
        
        // Status Global
        let selectedProductKey = null; 
        let selectedNominal = 0; 
        let selectedPrice = 0; 
        let selectedPaymentMethod = null; 
        let currentUniqueCode = 0; 
        let activeOrderId = null; 
        let paymentModal; 
        let checkStatusModal;
        let customerChatId = localStorage.getItem('amri_store_chat_id');

        // --- FUNGSI UTILITY GLOBAL ---
        function showLoading(message) { $('#loading-status').text(message); $('#loading-overlay').css('display', 'flex'); }
        function hideLoading() { $('#loading-overlay').css('display', 'none'); }
        function formatRupiah(number) { return 'Rp ' + parseInt(number).toLocaleString('id-ID'); }
        function formatPriceValue(number) {
            const num = parseInt(number);
            if (num >= 1000000) {
                const millionsK = (num / 1000).toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 3 });
                return `${millionsK}k`;
            }
            if (num >= 1000) {
                const thousands = num / 1000;
                return `${thousands}k`;
            }
            return num.toLocaleString('id-ID'); 
        }
        function formatEWalletNominal(number) { return parseInt(number).toLocaleString('id-ID'); }

        function showToast(message, isError = false) { 
            const toast = document.getElementById('custom-toast');
            toast.textContent = message;
            toast.style.display = 'block';
            toast.style.opacity = 0; 
            toast.style.transform = 'translateY(20px)'; 
            toast.style.backgroundColor = isError ? '#DC3545' : 'var(--color-primary-dark)'; 
            toast.style.color = isError ? 'white' : 'black'; 
            
            setTimeout(() => { toast.style.opacity = 1; toast.style.transform = 'translateY(0)'; }, 50);
            setTimeout(() => { toast.style.opacity = 0; toast.style.transform = 'translateY(-20px)'; setTimeout(() => toast.style.display = 'none', 500); }, 3000);
        }
        function generateUniqueId() { return 'U' + Math.random().toString(36).substring(2, 10).toUpperCase(); }
        function generateUniqueCode() { return Math.floor(Math.random() * (700 - 300 + 1)) + 300; }
        function generateOrderId() { return 'X' + Math.random().toString(36).substring(2, 10).toUpperCase(); }
        
        window.copyText = (id) => {
            const textToCopy = document.getElementById(id).textContent.replace('#', '');
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast('Berhasil disalin: ' + textToCopy);
            }).catch(err => {
                console.error('Gagal menyalin: ', err);
                showToast('Gagal menyalin.', true);
            });
        };

        function setupModals() {
            paymentModal = new bootstrap.Modal(document.getElementById('payment-modal'));
            checkStatusModal = new bootstrap.Modal(document.getElementById('check-status-modal')); 
        }

        function initializeFirebase() {
             try {
                 if (firebase.apps.length === 0) {
                     firebase.initializeApp(firebaseConfig);
                 }
                 db = firebase.database(); 
                 
                 if (!customerChatId) {
                     customerChatId = generateUniqueId();
                     localStorage.setItem('amri_store_chat_id', customerChatId);
                 }
                 
                 renderProductGrid(); 
                 setupModals();
                 updateCountdown(); 
                 checkFlashsaleStatus(); 
                 setInterval(updateCountdown, 1000); 
                 setInterval(checkFlashsaleStatus, 60000); 

                 AOS.init({ 
                    duration: 400, 
                    easing: 'ease-out-quad',
                    once: true 
                 });

             } catch (error) {
                 console.error("Firebase Inisialisasi Gagal: ", error);
                 showToast('Error fatal: Database gagal dimuat. Cek Console.', true);
             } finally {
                 hideLoading();
             }
        }
        
        // =========================================================
        //                 NAVIGASI & UI LOGIC
        // =========================================================
        function hideAllPages() {
            $('#main-page, #product-page, #chat-page, #privacy-policy-page, #terms-conditions-page, #contact-page').hide();
        }

        window.goToMainPage = () => {
            // **Pembersihan State & UI pada halaman produk**
            $('.nominal-item').removeClass('active');
            $('.payment-item').removeClass('active');
            $('#input-recipient-id-page').val('');
            
            // **Reset State Global**
            selectedProductKey = null;
            selectedNominal = 0; 
            selectedPrice = 0;
            selectedPaymentMethod = null;
            currentUniqueCode = 0;
            updateTagihan(); // Pastikan tagihan di-reset ke 0

            hideAllPages();
            $('#main-page').show().removeClass('animate__fadeOut animate__fadeOutLeft animate__fadeOutRight').addClass('animate__fadeInUp');
            $('#floating-chat-btn').show();
            $('#back-button').addClass('d-none');
            $('.navbar-toggler').show();
            $('.navbar-brand').removeClass('d-none');
            $('#nokos-manual-info').hide();
            
            const navbarCollapse = document.getElementById('navbarNav');
            const bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
            if (bsCollapse) {
                bsCollapse.hide();
            }
            window.scrollTo(0, 0);
            AOS.refresh();
        }

        window.handleBackButton = () => {
             if ($('#chat-page').is(':visible')) {
                 // Hentikan listener chat saat keluar
                 db.ref(CHAT_REF + customerChatId + '/messages').off('value'); 
                 $('#chat-page').removeClass('animate__fadeInLeft').addClass('animate__fadeOutLeft');
                 setTimeout(goToMainPage, 300); 
             } else if ($('#product-page').is(':visible')) {
                 goToMainPage();
             } else {
                 goToMainPage();
             }
        }

        // Fungsi untuk menampilkan halaman Kebijakan Privasi
        window.showPrivacyPolicy = () => {
            hideAllPages();
            $('#privacy-policy-page').show();
            $('#floating-chat-btn').hide();
            $('#back-button').removeClass('d-none');
            window.scrollTo(0, 0);
        }

        // Fungsi untuk menampilkan halaman Syarat dan Ketentuan
        window.showTermsConditions = () => {
            hideAllPages();
            $('#terms-conditions-page').show();
            $('#floating-chat-btn').hide();
            $('#back-button').removeClass('d-none');
            window.scrollTo(0, 0);
        }

        // Fungsi untuk menampilkan halaman Kontak
        window.showContact = () => {
            hideAllPages();
            $('#contact-page').show();
            $('#floating-chat-btn').hide();
            $('#back-button').removeClass('d-none');
            window.scrollTo(0, 0);
        }

        window.showProductPage = (key) => {
            if (key === 'NOKOS' && $('#flashsale-otp').hasClass('sold-out')) {
                showToast("Produk OTP Nokos saat ini sedang SOLD OUT, akan tersedia kembali pukul 13:00 WIB.", true);
                return;
            }

            hideAllPages();
            selectedProductKey = key;
            selectedNominal = 0; 
            selectedPrice = 0;
            selectedPaymentMethod = null;
            
            const product = PRODUCT_DATA[key];
            const isNokos = (key === 'NOKOS');
            const isPremiumOrNokos = (product.type === 'APP PREMIUM' || product.type === 'LAINNYA');
            
            $('#product-page-img').attr('src', product.image);
            $('#product-page-title').text(product.label); 
            $('#product-page-type').text(product.type); 
            
            const nominalTitleElement = $('#nominal-title');
            if (isPremiumOrNokos) {
                 nominalTitleElement.html('<i class="fas fa-list me-2" style="color: var(--color-primary-dark);"></i> 1. Pilih Kategori');
            } else {
                 nominalTitleElement.html('<i class="fas fa-list me-2" style="color: var(--color-primary-dark);"></i> 1. Pilih Nominal Top Up');
            }

            // **Validasi Nokos (Otomatis Pilih Nominal)**
            if (isNokos) {
                const nominal = Object.keys(product.nominals)[0];
                const price = product.nominals[nominal];
                
                $('#recipient-card').hide(); 
                $('#nokos-checkout-warning').show(); 
                selectNominal(null, nominal, price); // Auto select
                
            } else {
                $('#recipient-card').show(); 
                $('#nokos-checkout-warning').hide(); 
            }
            
            updateRecipientUI(product.type, 'page');
            renderNominalOptions(key, 'product-nominal-list');
            renderPaymentMethods('payment-method-selection-page');
            updateTagihan(); 
            
            $('#product-page').show().removeClass('animate__fadeOut animate__fadeOutRight animate__fadeInRight');
            
            $('#floating-chat-btn').hide(); 
            $('#back-button').removeClass('d-none');
            $('.navbar-toggler').hide();
            $('.navbar-brand').addClass('d-none');
            window.scrollTo(0, 0);
            AOS.refresh();
        }

        function updateRecipientUI(productType, suffix) {
            const label = $(`#recipient-label-${suffix}`);
            const help = $(`#recipient-help-${suffix}`);
            const input = $(`#input-recipient-id-${suffix}`);
            
            // Set input type ke 'text' secara default, agar ID game bisa menampung kurung
            input.attr('type', 'text'); 
            
            if (productType === 'GAME') {
                label.text('ID Game / User ID');
                help.text('Masukkan ID Game Anda (termasuk server ID jika ada, cth: 1234567890 (1234).');
                input.attr('placeholder', 'Cth: 1234567890 (1234)');
            } else if (productType === 'E-WALLET') {
                // E-WALLET lebih baik tetap 'text' agar tidak ada masalah dengan format nomor hp
                label.text('Nomor Tujuan / Nomor HP');
                help.text('Masukkan Nomor HP yang terdaftar pada E-Wallet (cth: 081234567890).');
                input.attr('placeholder', 'Cth: 081234567890');
                input.attr('type', 'number'); // Diubah kembali ke number untuk validasi dasar nomor HP
            } else if (productType === 'APP PREMIUM') {
                 label.text('Nomor WhatsApp Aktif Pembeli');
                 help.text('Akun premium akan dikirimkan ke Nomor WhatsApp ini setelah pembayaran berhasil. (Cth: 081234567890)');
                 input.attr('placeholder', 'Cth: 081234567890');
                 input.attr('type', 'number'); 
            } else if (productType === 'LAINNYA') {
                 label.text('Data Kontak (Nomor WA)');
                 help.text('Masukkan Nomor WhatsApp aktif Anda.');
                 input.attr('placeholder', 'Cth: 081234567890');
                 input.attr('type', 'number');
            }
            label.removeClass('fw-semibold').addClass('fw-normal'); 
        }
        
        function formatGameNominalString(nominalKey) {
             if (nominalKey === 'MINGGUAN') return 'Member Mingguan';
             if (nominalKey === 'BULANAN') return 'Member Bulanan';
             if (nominalKey === 'BP_CARD') return 'BP Card';
             
            // Logika App Premium
            if (nominalKey.startsWith('INVITE_')) return 'Canva Invite (1 Bulan)'; 
            if (nominalKey.startsWith('OWNER_')) return 'Canva Owner (1 Bulan)';
            if (nominalKey.startsWith('1_TAHUN')) return '1 Tahun';
            if (nominalKey.startsWith('1_BULAN_PRIVATE')) return '1 Bulan Private';
            if (nominalKey.includes('14_HARI_100P')) return '14 Hari (100 Peserta)'; 
            
            const parts = nominalKey.split('_');
            return parts.map(p => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()).join(' ');
        }

        function renderNominalOptions(productKey, containerId) {
            const container = $(`#${containerId}`);
            container.empty();
            const product = PRODUCT_DATA[productKey];
            const isNokos = (productKey === 'NOKOS');
            const isAppPremium = (product.type === 'APP PREMIUM'); 
            const isEWallet = (product.type === 'E-WALLET'); 
            const isGame = (product.type === 'GAME'); 
            const isFF = (productKey === 'FF'); 

            if (isNokos || isAppPremium || isEWallet || (isGame && !isFF)) {
                
                const sortedNominals = Object.keys(product.nominals).sort((a, b) => {
                     const numA = isNaN(a) ? Infinity : parseInt(a);
                     const numB = isNaN(b) ? Infinity : parseInt(b);
                     return numA - numB;
                });
                
                const nominalRow = $('<div class="row g-2"></div>');
                
                sortedNominals.forEach(nominal => {
                    const price = product.nominals[nominal];
                    
                    let displayNominal;
                    let nominalClass = '';
                    
                    if(isNokos) {
                        displayNominal = '<span class="nominal-label">1x OTP</span>';
                        nominalClass = 'nominal-item-nokos'; 
                    } else if (isAppPremium) {
                        displayNominal = `<span class="nominal-item-apppremium">${formatGameNominalString(nominal)}</span>`;
                    } else if (isGame) {
                        displayNominal = `<span class="nominal-item-game">${nominal} Diamond</span>`;
                    } else if (isEWallet) { 
                        displayNominal = `<span class="nominal-item-ewallet">${formatEWalletNominal(nominal)}</span>`; 
                        nominalClass = 'nominal-item-ewallet';
                    }
                    
                    const displayPrice = `<small class="price-label">${formatPriceValue(price)}</small>`;
                    const isActiveClass = (isNokos) ? 'active' : '';

                    nominalRow.append(`
                        <div class="col-4 col-md-3"> 
                            <div class="nominal-item ${isActiveClass} ${nominalClass}" data-nominal="${nominal}" data-price="${price}" onclick="selectNominal(this, '${nominal}', ${price})">
                                <p class="fw-normal mb-0">${displayNominal}</p>
                                ${displayPrice}
                            </div>
                        </div>
                    `);
                });
                container.append(nominalRow);

                // **BUGFIX:** Pastikan Nokos tidak bisa di-unselect
                if(isNokos) {
                     $('.nominal-item.active').attr('onclick', 'return false;');
                }
            } 
            else if (isFF) {
                const nominals = product.nominals;
                const diamondNominals = {};
                const membershipNominals = {};

                Object.keys(nominals).forEach(key => {
                    if (!isNaN(key)) {
                        diamondNominals[key] = nominals[key];
                    } else {
                        membershipNominals[key] = nominals[key];
                    }
                });

                // 2. Render Diamond
                container.append('<h6 class="fw-bold mt-2" style="color: #333;"><i class="fas fa-gem me-1"></i> Diamond</h6>');
                const diamondRow = $('<div class="row g-2 mb-4"></div>');
                
                Object.keys(diamondNominals).sort((a, b) => parseInt(a) - parseInt(b)).forEach(nominal => {
                    const price = diamondNominals[nominal];
                    const displayNominal = `<span class="nominal-item-game">${nominal} Diamond</span>`;
                    const displayPrice = `<small class="price-label">${formatPriceValue(price)}</small>`;
                    
                    diamondRow.append(`
                        <div class="col-4 col-md-3"> 
                            <div class="nominal-item" data-nominal="${nominal}" data-price="${price}" onclick="selectNominal(this, '${nominal}', ${price})">
                                <p class="fw-normal mb-0">${displayNominal}</p>
                                ${displayPrice}
                            </div>
                        </div>
                    `);
                });
                container.append(diamondRow);

                // 3. Render Membership/Card
                if (Object.keys(membershipNominals).length > 0) {
                     container.append('<h6 class="fw-bold mt-2" style="color: #333;"><i class="fas fa-certificate me-1"></i> Membership & BP Card</h6>');
                     const membershipRow = $('<div class="row g-2"></div>');

                     Object.keys(membershipNominals).forEach(nominal => {
                         const price = membershipNominals[nominal];
                         const displayNominal = `<span class="nominal-item-apppremium">${formatGameNominalString(nominal)}</span>`; 
                         const displayPrice = `<small class="price-label">${formatPriceValue(price)}</small>`;

                         membershipRow.append(`
                             <div class="col-6 col-md-4"> 
                                 <div class="nominal-item" data-nominal="${nominal}" data-price="${price}" onclick="selectNominal(this, '${nominal}', ${price})">
                                     <p class="fw-normal mb-0">${displayNominal}</p>
                                     ${displayPrice}
                                 </div>
                             </div>
                         `);
                     });
                     container.append(membershipRow);
                }
            }
        }
        
        window.selectNominal = (element, nominal, price) => {
            // **BUGFIX:** Hindari unselect jika element ada (kecuali Nokos yang memang auto-selected)
            if (selectedProductKey !== 'NOKOS') {
                $('.nominal-item').removeClass('active');
                if(element) $(element).addClass('active');
            } else if (element && selectedProductKey === 'NOKOS') {
                 // Hanya aktifkan jika memang item yang diklik adalah Nokos
                 $(element).addClass('active');
            }
            
            selectedNominal = nominal;
            selectedPrice = price;
            updateTagihan();
        }

        function renderPaymentMethods(containerId) {
            const container = $(`#${containerId}`);
            container.empty();
            
            Object.keys(PAYMENT_DETAILS).forEach(methodKey => {
                const method = PAYMENT_DETAILS[methodKey];
                const isQris = methodKey === 'QRIS';
                const extraText = isQris ? '<small class="d-block text-muted"></small>' : ''; 
                
                container.append(`
                    <div class="col-6 col-md-4">
                        <div class="payment-item" data-method="${methodKey}" onclick="selectPaymentMethod(this, '${methodKey}')">
                            <i class="${method.icon} fa-lg me-2 text-primary"></i> 
                            <span class="fw-normal">${method.label}</span>
                            ${extraText}
                        </div>
                    </div>
                `);
            });
        }
        
        window.selectPaymentMethod = (element, methodKey) => {
            $('.payment-item').removeClass('active');
            if(element) $(element).addClass('active');
            selectedPaymentMethod = methodKey;
            updateTagihan();
        }
        
        function updateTagihan() {
            // **BUGFIX:** Reset unique code jika harga menjadi 0
            if (selectedPrice === 0) {
                currentUniqueCode = 0;
            } else if (currentUniqueCode === 0) {
                currentUniqueCode = generateUniqueCode();
            }

            let finalPrice = selectedPrice;
            
            if (finalPrice > 0) {
                finalPrice += currentUniqueCode;
                
                $('#display-tagihan').text(formatRupiah(finalPrice));
                $('#display-unique-code').html(`(Termasuk kode unik: <span class="text-danger">${currentUniqueCode}</span>)`); 
                $('#input-final-amount').val(finalPrice);
            } else {
                $('#display-tagihan').text('0');
                $('#display-unique-code').text('');
                $('#input-final-amount').val(0);
            }
        }

        // --- FUNGSI ORDER & STATUS ---
        window.processOrderFromPage = () => {
            const recipientId = $('#input-recipient-id-page').val().trim();
            const finalAmount = parseInt($('#input-final-amount').val());
            const isNokosOrder = selectedProductKey === 'NOKOS';
            
            if (!selectedNominal || selectedPrice === 0) return showToast('Pilih Kategori/Nominal terlebih dahulu!', true);
            
            if (!selectedPaymentMethod) return showToast('Pilih Metode Pembayaran!', true);
            
            // --- LOGIKA VALIDASI RECIPIENT ---
            if (!isNokosOrder && !recipientId) { 
                return showToast('Masukkan ID tujuan/Nomor WhatsApp aktif Anda dengan benar!', true);
            }
            
            showLoading('Memproses pesanan...');

            activeOrderId = generateOrderId();
            
            const product = PRODUCT_DATA[selectedProductKey];
            const isAppPremiumOrder = product.type === 'APP PREMIUM';
            const isFFMembershipOrder = selectedProductKey === 'FF' && isNaN(selectedNominal); 

            let displayNominal;
            let isItemYangPerluChat = isNokosOrder || isAppPremiumOrder || isFFMembershipOrder;

            if (isAppPremiumOrder || isFFMembershipOrder) {
                displayNominal = formatGameNominalString(selectedNominal);
            } else if (isNokosOrder) {
                displayNominal = '1x OTP';
            } else if (product.type === 'E-WALLET') {
                displayNominal = formatRupiah(parseInt(selectedNominal));
            } else {
                displayNominal = `${selectedNominal} Diamond`;
            }

            const orderData = {
                orderId: activeOrderId,
                productKey: selectedProductKey,
                productName: product.label,
                nominal: displayNominal,
                // **Penting:** Pastikan recipientId tersimpan 'N/A' jika Nokos, atau string kosong jika user lupa isi (walau sudah divalidasi)
                recipientId: isNokosOrder ? 'N/A' : (recipientId || 'Belum diisi'), 
                price: selectedPrice,
                paymentMethod: selectedPaymentMethod,
                finalAmount: finalAmount,
                uniqueCode: currentUniqueCode,
                status: 'Menunggu Pembayaran',
                timestamp: new Date().toISOString()
            };

            db.ref(ORDERS_REF + activeOrderId).set(orderData)
            .then(() => {
                hideLoading();
                showPaymentModal(orderData, isItemYangPerluChat);
                
                // Reset halaman produk
                $('#input-recipient-id-page').val('');
                selectNominal(null, 0, 0); 
                selectPaymentMethod(null, '');
                goToMainPage(); // Kembali ke halaman utama setelah order

            })
            .catch(error => {
                hideLoading();
                console.error("Gagal menyimpan order: ", error);
                showToast('Gagal memproses pesanan. Coba lagi.', true);
            });
        }

        function showPaymentModal(order, isItemYangPerluChat) {
            const method = PAYMENT_DETAILS[order.paymentMethod];
            let content = '';
            
            const formattedTotal = formatRupiah(order.finalAmount);

            if (order.paymentMethod === 'QRIS') {
                content = `
                    <p class="text-danger fw-normal fs-4">TOTAL: ${formattedTotal}</p>
                    <p class="text-dark">Lakukan pembayaran dengan scan QRIS di bawah ini:</p>
                    <a href="${method.image_url}" target="_blank">
                       <img src="${method.image_url}" class="img-fluid rounded" style="max-width: 250px;" alt="QRIS Code">
                    </a>
                    <p class="mt-3 small text-muted">Pastikan jumlah yang ditransfer sama persis dengan total tagihan, termasuk kode unik ${order.uniqueCode}.</p>
                `;
            } else {
                content = `
                    <p class="text-danger fw-normal fs-4">TOTAL: ${formattedTotal}</p>
                    <p class="text-dark">Transfer ke:</p>
                    <h5 class="mb-1" style="color: #333; font-weight: 500;">${method.label} (${method.name})</h5> 
                    <span class="fs-4 text-dark" id="copy-number">${method.number}</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="copyText('copy-number')"><i class="fas fa-copy"></i> Salin</button>
                    <p class="mt-3 small text-muted">Pastikan jumlah yang ditransfer sama persis dengan total tagihan, termasuk kode unik ${order.uniqueCode}.</p>
                `;
            }
            
            let buttonHtml = '';
            let modalFooterWarning = '';

            if (isItemYangPerluChat) {
                 buttonHtml = `
                    <button class="btn btn-lg w-100 mt-3 btn-process-order" 
                            onclick="paymentModal.hide(); startCustomerChat(true, ${JSON.stringify(order)}); "> 
                        <i class="fas fa-comments me-2"></i> SALIN ID PESANAN ANDA DI POJOK KANAN BAWAH
                    </button>
                 `;
                 
                 const nominalDisplay = order.nominal;
                 
                 if (order.productKey === 'NOKOS') {
                     modalFooterWarning = `
                         <p class="small mt-2" style="color: #666;">!! SETELAH PEMBAYARAN BERHASIL SALIN ID PESANAN ANDA MASUK KE LIVE CHAT LALU PASTE DAN KIRIM ID PESANANAN ANDA KE ADMIN  !!</p>
                         <p class="small mt-2 text-dark"></p>`;
                 } else if (order.productKey === 'FF' && (nominalDisplay.includes('Member') || nominalDisplay.includes('BP Card'))) { 
                     modalFooterWarning = `
                         <p class="small mt-2" style="color: #666;">HADUH EROR</p>
                         <p class="small mt-2 text-dark">Setelah masuk chat, kirim **bukti bayar** dan tunggu Admin memproses ${nominalDisplay} ke ID Game Anda (${order.recipientId}).</p>`;
                 } else { // App Premium
                     modalFooterWarning = `
                         <p class="small mt-2" style="color: #666;"></p>
                         <p class="small mt-2 text-dark">Setelah pembayaran berhasil, tunggu Admin mengirimkan akun premium ke WhatsApp Anda (${order.recipientId}).</p>`;
                 }

            } else {
                 buttonHtml = `
                    <button class="btn btn-lg w-100 mt-3" style="background-color: var(--color-primary-dark); color: black;" data-bs-dismiss="modal">
                        <i class="fas fa-check-circle me-2"></i> OK, SAYA AKAN BAYAR
                    </button>
                 `;
            }
            
            const finalContent = content + buttonHtml + modalFooterWarning;

            $('#modal-order-id-display').text(order.orderId);
            $('#modal-payment-content').html(finalContent);
            paymentModal.show();
        }

        window.showCheckStatusModal = () => {
            $('#input-check-order-id').val('');
            $('#order-status-result').hide().empty();
            checkStatusModal.show();
        }
        
        window.checkOrderStatus = () => {
            const orderId = $('#input-check-order-id').val().trim().toUpperCase();
            const resultDiv = $('#order-status-result');
            
            if (!orderId) {
                resultDiv.html('<p class="text-danger">Masukkan ID Pesanan yang valid.</p>').show();
                return;
            }
            
            showLoading('Mencari pesanan...');
            
            db.ref(ORDERS_REF + orderId).once('value', snapshot => {
                hideLoading();
                const order = snapshot.val();
                
                if (order) {
                    let statusClass = 'text-warning';
                    if (order.status === 'Selesai') statusClass = 'text-success';
                    if (order.status === 'Dibatalkan') statusClass = 'text-danger';
                    
                    const recipientInfo = order.recipientId && order.recipientId !== 'N/A' 
                                            ? `<p class="mb-1">Tujuan: ${order.recipientId}</p>` 
                                            : '';


                    resultDiv.html(`
                        <p class="fw-normal mb-1">ID Pesanan: ${order.orderId}</p>
                        <p class="mb-1">Produk: ${order.productName} (${order.nominal})</p>
                        ${recipientInfo}
                        <p class="mb-1">Pembayaran: ${order.paymentMethod}</p>
                        <p class="mb-1">Total Tagihan: <span class="text-danger">${formatRupiah(order.finalAmount)}</span></p>
                        <p class="fw-normal mt-2">Status: <span class="${statusClass}">${order.status}</span></p>
                        <p class="small text-muted mt-2">Waktu Order: ${new Date(order.timestamp).toLocaleString()}</p>
                    `).show();
                } else {
                    resultDiv.html('<p class="text-danger">Pesanan dengan ID tersebut tidak ditemukan.</p>').show();
                }
            });
        }
        
        function renderProductGrid() {
            const gridContainer = $('#product-grid');
            gridContainer.empty();
            
            const productKeys = Object.keys(PRODUCT_DATA).filter(key => key !== 'NOKOS'); 
            const gameProducts = productKeys.filter(key => PRODUCT_DATA[key].type === 'GAME');
            const ewalletProducts = productKeys.filter(key => PRODUCT_DATA[key].type === 'E-WALLET');
            const appPremiumProducts = productKeys.filter(key => PRODUCT_DATA[key].type === 'APP PREMIUM'); 
            
            // --- Bagian TOP UP GAME ---
            if (gameProducts.length > 0) {
                gridContainer.append('<h5 class="subsection-title" data-aos="fade-up"><i class="fas fa-gamepad me-2"></i> TOP UP GAME</h5>');
                const gameRow = $('<div class="row g-3" data-aos="fade-up"></div>');
                
                gameProducts.forEach(key => {
                    const product = PRODUCT_DATA[key];
                    gameRow.append(`
                        <div class="col-6 col-sm-4 col-md-3">
                            <div class="product-card" onclick="showProductPage('${key}')">
                                <img src="${product.image}" alt="${product.label}">
                                <p class="fw-normal mb-0">${product.label}</p>
                            </div>
                        </div>
                    `);
                });
                gridContainer.append(gameRow);
            }

            // --- Bagian TOP UP E-WALLET ---
            if (ewalletProducts.length > 0) {
                gridContainer.append('<h5 class="subsection-title" data-aos="fade-up"><i class="fas fa-wallet me-2"></i> TOP UP E-WALLET</h5>');
                const ewalletRow = $('<div class="row g-3" data-aos="fade-up"></div>');

                ewalletProducts.forEach(key => {
                    const product = PRODUCT_DATA[key];
                    ewalletRow.append(`
                        <div class="col-6 col-sm-4 col-md-3">
                            <div class="product-card" onclick="showProductPage('${key}')">
                                <img src="${product.image}" alt="${product.label}">
                                <p class="fw-normal mb-0">${product.label}</p>
                            </div>
                        </div>
                    `);
                });
                gridContainer.append(ewalletRow);
            }

            // --- Bagian APP PREMIUM ---
            if (appPremiumProducts.length > 0) {
                gridContainer.append('<h5 class="subsection-title" data-aos="fade-up"><i class="fas fa-crown me-2"></i> APP PREMIUM</h5>');
                const appPremiumRow = $('<div class="row g-3" data-aos="fade-up"></div>');

                appPremiumProducts.forEach(key => {
                    const product = PRODUCT_DATA[key];
                    appPremiumRow.append(`
                        <div class="col-6 col-sm-4 col-md-3">
                            <div class="product-card" onclick="showProductPage('${key}')">
                                <img src="${product.image}" alt="${product.label}">
                                <p class="fw-normal mb-0">${product.label}</p>
                            </div>
                        </div>
                    `);
                });
                gridContainer.append(appPremiumRow);
            }
        }
        
        function updateCountdown() {
            const targetTime = new Date();
            // **BUGFIX LOGIKA WAKTU FLASHSALE**
            // Flashsale dimulai jam 13:00 (13), berakhir jam 00:59 (0)
            const now = new Date();
            let distance;
            
            if (now.getHours() < 13) {
                 // Jika sebelum jam 13:00, hitung mundur sampai jam 13:00 hari ini
                 targetTime.setHours(13, 0, 0, 0); 
            } else {
                 // Jika setelah jam 13:00, hitung mundur sampai jam 00:00 (tengah malam) hari berikutnya.
                 targetTime.setHours(24, 0, 0, 0); // Sama dengan 00:00 hari berikutnya
            }
            
            distance = targetTime - now;

            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            $('#cd-h').text(hours.toString().padStart(2, '0'));
            $('#cd-m').text(minutes.toString().padStart(2, '0'));
            $('#cd-s').text(seconds.toString().padStart(2, '0'));
        }

        function checkFlashsaleStatus() {
            const now = new Date();
            const hour = now.getHours();
            
            // SOLD OUT dari jam 01:00 (1) sampai 12:59 (12)
            const isSoldOut = (hour >= 1 && hour <= 12); 
            
            const flashsaleItem = $('#flashsale-otp');
            const indicator = $('#flashsale-indicator');
            
            flashsaleItem.find('.sold-out-text').remove();
            
            if (isSoldOut) {
                flashsaleItem.addClass('sold-out').attr('onclick', 'showToast("Produk OTP Nokos saat ini sedang SOLD OUT, akan tersedia kembali pukul 13:00 WIB.", true)');
                indicator.hide();
                flashsaleItem.find('.text-content').append('<span class="sold-out-text">SOLD OUT</span>'); 
            } else {
                flashsaleItem.removeClass('sold-out').attr('onclick', "showProductPage('NOKOS')");
                indicator.show();
            }
        }


        // =========================================================
        //                 LOGIKA LIVE CHAT CUSTOMER
        // =========================================================
        window.startCustomerChat = (isNokosOrAppPremiumOrder, orderData = null) => {
             hideAllPages();
             $('#chat-page').show().removeClass('animate__fadeOutLeft').addClass('animate__fadeInLeft');
             $('#floating-chat-btn').hide(); 
             $('#back-button').removeClass('d-none');
             
             const infoDiv = $('#nokos-manual-info');
             
             // Pastikan chat log bersih dari listener sebelumnya
             db.ref(CHAT_REF + customerChatId + '/messages').off('value'); 
             
             if(isNokosOrAppPremiumOrder && orderData) {
                 const product = orderData ? PRODUCT_DATA[orderData.productKey] : null;
                 const isAppPremiumOrder = product && product.type === 'APP PREMIUM';
                 const isFFMembershipOrder = orderData.productKey === 'FF' && product && (orderData.nominal.includes('Member') || orderData.nominal.includes('BP Card'));
                 const nominalDisplay = orderData.nominal; 
                 let infoMessage;
                 
                 if (isAppPremiumOrder || isFFMembershipOrder) {
                     infoMessage = `
                        <p class="fw-normal mb-1" style="color: var(--color-accent-green);">âœ… **KONFIRMASI ORDER ${orderData.productName.toUpperCase()}**</p>
                        <p class="small mb-2" style="color: #333;">ID: <span class="fw-bold">${orderData.orderId}</span> | Nominal: <span class="fw-bold">${nominalDisplay}</span> | Total: <span class="fw-bold" style="color: #DC3545;">${formatRupiah(orderData.finalAmount)}</span> (${orderData.paymentMethod})</p>
                        <p class="small mb-2" style="color: #333;">Langkah Selanjutnya:</p>
                        <ol class="small mb-2 ps-3" style="color: #333;">
                            <li>Ketik pesan Anda dan kirimkan **bukti transfer** di chat ini.</li>
                            <li>Admin akan memproses ke ID/WA: <span class="fw-bold">${orderData.recipientId}</span>.</li>
                        </ol>
                     `;
                 } else { // Nokos Order
                     infoMessage = `
                        <p class="fw-normal mb-1" style="color: var(--color-accent-green);">âœ… **KONFIRMASI ORDER NOKOS**</p>
                        <p class="small mb-2" style="color: #333;">ID: <span class="fw-bold">${orderData.orderId}</span> | Total: <span class="fw-bold" style="color: #DC3545;">${formatRupiah(orderData.finalAmount)}</span> (${orderData.paymentMethod})</p>
                        <p class="small mb-2" style="color: #333;">Langkah Selanjutnya:</p>
                        <ol class="small mb-2 ps-3" style="color: #333;">
                            <li>Ketik pesan Anda dan kirimkan **bukti transfer** di chat ini.</li>
                            <li>Tuliskan **Nomor tujuan OTP** yang ingin Anda gunakan.</li>
                        </ol>
                     `;
                 }
                 infoDiv.html(infoMessage).show();

             } else {
                 infoDiv.hide();
             }
             
             db.ref(CHAT_REF + customerChatId).update({
                 last_active: new Date().toISOString(),
                 customer_id: customerChatId,
                 status: 'open',
                 customer_name: `Pelanggan ${customerChatId.substring(1, 5)}`
             });

             listenForCustomerMessages(customerChatId);
             AOS.refresh();
        }

        function listenForCustomerMessages(chatId) {
             const chatLog = $('#customer-chat-log');
             // Listener dipanggil dari startCustomerChat() setelah listener sebelumnya di-off()
             db.ref(CHAT_REF + chatId + '/messages').on('value', (snapshot) => {
                 chatLog.empty();
                 const messages = snapshot.val();
                 if (messages) {
                     Object.values(messages).forEach(msg => {
                         const senderClass = (msg.sender === 'customer') ? 'message-sender' : (msg.sender === 'system' ? 'text-start text-danger' : 'message-receiver');
                         
                         let messageHtml;
                         if (msg.sender === 'system') {
                             messageHtml = `<div class="text-center small text-muted my-2">${msg.text}</div>`;
                         } else {
                             messageHtml = `
                                 <div class="d-flex ${msg.sender === 'customer' ? 'justify-content-end' : ''}">
                                     <div class="message-box ${senderClass}">
                                         ${msg.text}
                                         <div class="small text-end" style="opacity: 0.7; font-size: 0.7rem;">${new Date(msg.timestamp).toLocaleTimeString('id-ID')}</div>
                                     </div>
                                 </div>
                             `;
                         }
                         chatLog.append(messageHtml);
                     });
                     chatLog.scrollTop(chatLog[0].scrollHeight); 
                 } else { chatLog.html('<p class="text-center text-muted p-3">Mulai percakapan...</p>'); }
             });
        }

        window.sendCustomerMessage = () => {
            const input = $('#customer-chat-input');
            const message = input.val().trim();
            if (message === '') return;

            db.ref(CHAT_REF + customerChatId + '/messages').push({
                text: message,
                sender: 'customer',
                timestamp: new Date().toISOString()
            });
            
             db.ref(CHAT_REF + customerChatId).update({
                last_message: message,
                last_active: new Date().toISOString(),
                unread_admin: firebase.database.ServerValue.increment(1) 
            });

            input.val('');
        }

        // =========================================================
        //                 INITIALIZATION
        // =========================================================

        $(document).ready(function() {
            showLoading('Menghubungkan ke server...'); 
            initializeFirebase();
            goToMainPage();
        });
    </script>
</body>
</html>
